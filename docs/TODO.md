# TODO

## Done

- âœ… rename current netlify site `npc->cli` -> `the-last-redoubt`
  - https://the-last-redoubt.netlify.app/test/
  - https://staging.lastredoubt.co
- âœ… connect new netlify deploy, named `npc-cli`
  - https://npc-cli.netlify.app/
- âœ… fix initial font load: svg fontawesome
- âœ… start new desktop layout i.e. with right-pane
- âœ… use system fonts instead of web fonts

- âœ… add mobile layout i.e. with lower-pane
- âœ… mobile layout fixes

- âœ… easier to close Nav
- âœ… easier to close Viewer

- âœ… Viewer has Tabs
  - try avoid "cannot update component" error
- âœ… fix Viewer side-by-side Tabs minimize in large viewport

- âœ… fix layout height on mobile device

- âœ… useSiteStore drives Nav
- âœ… open Viewer closes Nav
- âœ… open Nav darkens Main
- âœ… Viewer Tabs has id `{articleKey}-viewer-tabs` (for persist)

- âœ… Tabs has controls
  - âœ… small viewport ui
  - âœ… large viewport ui
  - âœ… disable/enable
  - âœ… reset
  - âœ… maximise/minimise
    - by expanding Viewer

- âœ… can reset while paused
- âœ… close Viewer disables Tabs
- âœ… can max/min while paused
- âœ… can make Viewer larger

- âœ… fix max Viewer in large viewport
- âœ… Viewer tabs does not need to know articleKey
- âœ… fix darken overlay in small viewport
- âœ… move Controls outside Tabs as ViewerControls
- âœ… move Toggle inside ViewerControls
- âœ… ViewerControls always visible
- âœ… ViewerControls buttons/Toggle not positioned absolute
- âœ… remember if Viewer is open and trigger client-side

- âœ… can drag Viewer bar
  - âœ… can drag "drag-bar" instead
  - âœ… drag to 0% and let go => sets viewOpen `false`
  - âœ… when viewOpen false can start dragging
  - âœ… add overlay when dragging (body can be covered by iframe)
  - âœ… get resize working on mobile
  - âŒ CSS var --view-size driven by useSite

- âœ… Couldn't scroll iframe in `<Comments>`
  - Problem disappeared after restarting Chrome

- âœ… Nav icons for Blog, Dev, Help, About

  - Blog: `robot`
  - Dev: `code`
  - Help: `circle-question`
  - About: `circle-info`

- âŒ toasts indicate loading assets/components

- âœ… copy over sh folder
  - comment out references to e.g. World, NPC, Geom, PanZoom,
- âœ… rename src/js -> src/npc-cli
- âœ… add Terminal
  - âœ… add files to src/npc-cli/terminal
  - âœ… move tabs inside npc-cli
  - âœ… can see component in Tabs

- âœ… ensure Tab components are lazy-loaded

- âŒ pivot to NPC fixes in repo `the-last-redoubt`
  - Spine-based animation not good enough
  - too many other issues e.g. collisions

- âœ… add `npc-cli/geom`
- âœ… starting migrating `npc-cli/graph`

- âœ… setup SVG symbols (simplify existing system)
  - âœ… hull symbol
  - âœ… non-hull symbol
  - âœ… `yarn symbols-meta`
    - âœ… try universal replacement for cheerio `htmlparser2`
  - âœ… script watches files
  - âœ… other hull symbols
  - âœ… can extract `gm.pngRect`
    - âœ… given def `gms` construct each `gm.pngRect`
      - i.e. `layout.items[0].pngRect` (hull symbol)
      - i.e. from symbolLookup generated by `yarn svg-meta`

- âœ… add working react-three-fiber demo R3FDemo

- âœ… Tab doesn't need to use react-query
- âœ… If Tabs enabled, Reset does not disable
- âœ… Tabs should go disabled on when leave view
- âŒ No resize Canvas when not rendering
  - part of `Canvas`

- âœ… R3FDemo (TestWorld) improvements
  - âœ… renderer stops when paused
  - âœ… mouse zooms to point under cursor
  - âœ… initially rotates
  - âœ… fix z-fighting (hack)
  - âœ… rename as TestWorld; rename worker demo as TestWorker
  - âœ… fix z-fighting properly: additive blending, depthWrite false
  - âœ… "Preserve" R3FDemo height when disabled
  - âŒ start migrating character controller with soldier.fbx
    - https://discourse.threejs.org/t/character-controller/46936

- âœ… try https://github.com/pmndrs/react-three-offscreen
  - âœ… create simple demo
  - âœ… fixing resizing
  - âœ… add prop-passing via messaging
    - âœ… keep worker in another file
    - âœ… test patch
    - https://github.com/pmndrs/react-three-offscreen/issues/8#issuecomment-1975397224

- âœ… non-terminal tab disabled when other tab maximized
  - TestWorker was showing when Tab was minimized

- âœ… Can Esc/Enter to enable/disable in Terminal/Tabs
- âœ… Terminal rendered using WebGL
  - fix HMR via `npm i xterm-addon-webgl` https://github.com/xtermjs/xterm.js/issues/4757

- âœ… abstract `TestWorld` as `TestCanvas`
  - âœ… `TestCanvas` has generic prop `childComponent` e.g. `Scene` not `<Scene />`
  - âœ… `TestCanvas` has prop `sceneProps` to be used as `<Scene {...sceneProps} />`
  - âœ… create test scene `TestCharacter` and hook up to `Viewer`

- âœ… Fix remount issue
  - `TestScene` was exporting `customQuadGeometry` which broke HMR

- âœ… geomorph 301 position slightly wrong?

- âŒ start "GeomorphEdit" in TestWorld
  - âœ… `TestWorld` -> `TestWorldScene` in `TestCanvas`
  - âœ… remove `TestWorld`
  - âŒ start map-level UI with `HTMLSelectElement`s
  - âœ… THREE gridHelper -> single quad infiniteGridHelper
    - fix jsx type
  - âŒ can detect click geomorphs or hull doors
  - â„¹ï¸ use SVG editor instead, rep gms as e.g. 1200 * 1200 boxes

- âœ… `TestCanvas` has div ContextMenu shown on LongPress or RMB
    - âœ… when click outside scene
    - âœ… when click on floor in TestScene

- âœ… Don't use a web worker, here's why:
  - `<NPC>` should use react-three-fiber
  - But then js representation `state` inaccessible from main thread
  - TTY code runs in main thread, so would need another rep + communication
  - More generally would have to wrap THREE in a communication API.
  - We can return to "web worker approach" once the project is more mature

## WIP

- ğŸš§ TestCharacter (character controller)
  - âœ… simple demo using https://github.com/pmndrs/ecctrl
  - ğŸš§ BUG ecctrl is panning on drag outside canvas
    - https://github.com/pmndrs/ecctrl/issues/34
    - create patch in the meantime
  - ğŸš§ sporadic issue with pause i.e. scene disappears
    - âŒ `THREE.WebGLRenderer: Context Lost`
    - âœ… pause physics
    - âœ… disable CameraControls
    - ğŸš§ frameloop must be `demand` instead of `never`?
  - use character Soldier with animations
  - use custom character via Mixamo (use Blender to combine animations)
  - click to move
  - extract code, removing e.g. ray-cast

- âœ… can layout map using SVG with geomorph placeholders (rects)
  - âœ… create example layout svg
  - âœ… `symbols-meta.json` -> `assets-meta.json`
  - âœ… parse maps and store in `assets-meta.json`
  - âœ… why is loaded map "in wrong position" ?
    - was referencing stale prop
  - âœ… `TestScene` reads from JSON and updates onchange
    - requires window refocus
  - âœ… avoid window refocus
    - âœ… can extend gatsby with dev-only endpoints
    - âŒ endpoint `GET /dev-events` (for EventSource) and `POST /dev-files-changed`
    - âœ… create websocket server and test browser connect
      ```js
      const url = "ws://localhost:8012/echo"
      const wsClient = new WebSocket(url)
      wsClient.onmessage = e => console.log('message', e)
      wsClient.send(JSON.stringify({ yo: 'dawg' }))
      ```
    - âœ… can trigger websocket via curl
      ```sh
      curl -XPOST -H 'content-type: application/json' \
        localhost:8012/send-dev-event \
        --data '{ "hello": "world!" }'
      ```
    - âœ… script assets-meta triggers websocket (if it exists)
    - âœ… browser triggers react-query refetch

- ğŸš§ hull symbols have folder `symbols`, using placeholders
  - â„¹ï¸ placeholders are partially transparent boxes of symbol filename's dimension
  - âœ… add stateroom symbol
  - âœ… extract during `yarn assets-meta`
  - ğŸš§ clarify conversion from { rect, transform } -> transform

- Learn about WebGl RenderTargets
  - Towards "Pixi.js RenderTexture" functionality
  - https://blog.maximeheckel.com/posts/the-study-of-shaders-with-react-three-fiber/
  - https://blog.maximeheckel.com/posts/beautiful-and-mind-bending-effects-with-webgl-render-targets/

- ğŸš§ try fix sporadic missing updates
  - âœ… move maps to `media/map`
  - âœ… improve remount keys
- âœ… integer accuracy when parsing maps
  - Boxy has rounding errors e.g. when reflect
  - â„¹ï¸ seems fixed after setting Boxy accuracy as maximum (attr + transform)
- migrate Triangle
- âŒ try migrate R3FDemo to react-three-offscreen
- sh `test {fn}` evaluates function with `map` args
- improve MapControls zoomToCursor on mobile
- Terminal crashing during HMR
  - possibly fixed via `xterm-addon-webgl@beta`
- (hull) walls -> quads
- need to remove labels from hull symbol image?
- try avoid alphaBlend geomorphs via alphaMap
- Firefox android allows unbounded scrolling on "interact"
  - debug locally using about:debugging#/runtime/this-firefox

- if Viewer maximised and choose menu item, halve size of the Viewer

- if only open Viewer a tiny amount then it should close itself

- world editor in new repo
- geomorph editor in new repo
- despite our "generic aim" (fabricating game masters),
  some context will help e.g. The Last Redoubt

- âœ… smaller collapsed nav on mobile
- fix multi-touch flicker on drag
  - setup local dev on phone to debug this
- can add Tabs via links in blog posts
  - without remounting other tabs!
- open Viewer should enable Tabs initially
- can press Escape/Enter to pause/unpause
- how does shell function versioning work in sh/scripts.ts?
- fix vertical tab drag on mobile
  - need repro

- iOS issues:
  - âœ… Nav wasn't centred
  - âœ… Viewer initially partially occluded
  - seems fixed on iPhone 13

- more decor images
  - `computer-2`
  - `speaker-1`
  - `communicator-1`
  - `fabricator-1`
- place decor points on many tables
- more tables in 301
- more tables in 101
- World WebGL rendering pauses on pause Tabs

- install cypress to test terminal
- netlify site `npc-cli` at https://lastredoubt.co
